import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.ResultSetMetaData;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.Scanner;

/*
 * autheur Cédric Lambin
 */
public class Connect {

	  public static void main(String[] args) {
	    try {
	      Class.forName("org.postgresql.Driver");
	         
	      String url = "jdbc:postgresql://localhost:5432/Chat";
	      String user = "postgres";
	      String passwd = "sql";
	      Connection conn = DriverManager.getConnection(url, user, passwd);
	      Scanner sc = new Scanner(System.in);  
	      
	      //Création d'un objet Statement
	      Statement state = conn.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE, 
	    		  ResultSet.CONCUR_UPDATABLE); // resultSet peut etre mis à jour
	      char rep = 'x';
	      System.out.println("Bonjour, etes vous déjà inscrit ?");
	      System.out.println("Veuillez répondre par O/N uniquement");
	      try{
	      while(rep != 'O' || rep != 'N'){
	    	  String str = sc.nextLine().toUpperCase();
		      rep = str.charAt(0);
		      if (rep == 'O') {
		    	  while(true){
		    		  
		    	  
			    	  System.out.println("Entrez votre login :");
			    	  String pseudo = sc.nextLine();
				      ResultSet result = state.executeQuery("select cls_pseudo from inscription where cls_pseudo = '" + pseudo + "'");
				  
			    		 
			    	      if(!result.next()){
			    	    	 
				    	  System.out.println("login incorrect");
				    	  System.out.println("Entrez de nouveau votre login: ");
				    	
				     
				      }
				      else{
				    	  pseudo = result.getString("cls_pseudo");
				    	  System.out.println("Pseudo entré et correct: " + pseudo);
				    	  
				      System.out.println("login correct");
				      
				      System.out.println("Veuillez entrer votre mot de passe :");
				      String pass = sc.nextLine();
				      ResultSet rs = state.executeQuery("select cls_pseudo from inscription where cls_password = '" + pass + "'");
				      rs.first();
				      pass = rs.getString("cls_pseudo");
				      System.out.println("pseudo correspondant au mdp: " + pass);
				      System.out.println("pseudo entré : " + pseudo);
				     
				      		
					    	  if(pass.equals(pseudo)){
					    		  System.out.println("mot de passe correct");
					    	  	  System.out.println("Bienvenue " + pseudo + " :");
					    	  	  break;
					    	  }
					      
					      else{
					    	  System.out.println("mot de passe erroné");
					      }
					  }
			    	      result.close();
		    	  }
		      }
		      
		      else if(rep == 'N'){
		    	  System.out.println("Créez votre login :");
			      String pseudo = sc.nextLine();
			      System.out.println("vous avez saisi " + pseudo + " comme pseudo");
			      
			      System.out.println("Créez votre password : ");
			      String pass = sc.nextLine();
			      System.out.println("vous avez saisi " + pass + " comme password");
			      state.executeUpdate("INSERT INTO inscription " + "VALUES ('" + pass + "', '" + pseudo + "')");
			      System.out.println("Bravo, vous etes maintenant inscrit dans la base de données !!!");
			      System.out.println("Bienvenue parmi nous " + pseudo + ", commencez votre premiere discussion :");
		      }
		      else {
		    	  System.out.println("Veuillez entrez uniquement la lettre O ou N !");
		      }
	      }
	      }catch (SQLException e){
	    	  e.printStackTrace();
	    	  
	      }
	      
	     state.close();
	         
	    } catch (Exception e) {
	     e.printStackTrace();
	    }      
	  }
	}
//reste a faire : créer une table pour les conversations, proposer quelles conversations on veut rejoindre, clé primaire sur l'id de la discussion
//
